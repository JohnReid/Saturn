---
title: "Get negative and position FASTA sequences for a TF"
author: John Reid
output: html_document
params:
  TF: CTCF
---

```{r renderMe, eval = FALSE, echo = FALSE}
#
# Execute this block to render this document.
#
devtools::load_all()
if (FALSE) {
    rmarkdown::render("get-TF-fasta.Rmd", params = list(TF = "CTCF"))
} else {
    for (TF in levels(tfs$TF)) {
        rmarkdown::render(
            "get-TF-fasta.Rmd",
            output_file = str_c('FASTA-', TF, '.html'),
            params = list(TF = TF))
    }
}
```

Load the ChIP data for `{r params$TF}`.
```{r loadChip}
library(Saturn)
TF <- params$TF
chip.labels <- load.chip.labels(TF)
```

Analyse the ChIP data to see which regions bind in at least one cell type.
```{r getPositive}
is.bound <- Map(function(x) 3 == x, as.list(mcols(chip.labels)))
bound <- Reduce(function(x,y) x | y, is.bound)
positive <- chip.labels[bound]
```
We have `r length(positive)` positive ChIP regions.

Determine maximum DNase levels across cell types in the negative sequences.
```{r dnase}
tf.cells <- unrify(colnames(mcols(chip.labels)))
dnase.cells <- lapply(as.character(tf.cells), function(cell) summarise.dnase(cell, 'relaxed'))
dnase.max <- Reduce(pmax, dnase.cells)
```

Sort the sequences by their maximum DNase levels and select those with
the highest levels that are not bound
```{r getNegative}
# Check we have at least as many negative sequences.
dnase.max.idx <- order(dnase.max, decreasing = TRUE)
chip.labels.ordered <- chip.labels[dnase.max.idx]
is.unbound <- Map(function(x) 3 != x, as.list(mcols(chip.labels.ordered)))
unbound <- Reduce(function(x,y) x & y, is.unbound)
negative <- chip.labels.ordered[unbound]
stopifnot(length(negative) >= length(positive))
negative <- negative[1:length(positive)]
stopifnot(length(negative) == length(positive))
```
We have `r length(negative)` negative ChIP regions.

Write the positive and negative sequences to separate FASTA files.
```{r writeSeqs}
write.seqs <- function(gr, label) {
    seqs <- BSgenome::getSeq(hg19, gr)
    names(seqs) <- str_c(TF, ".", label, ".", chrom(gr), ':', start(gr), ':', end(gr))
    fasta <- file.path(saturn.data(), 'ChIPseq', 'seqs', str_c(TF, '-', label, '.fa'))
    Biostrings::writeXStringSet(seqs, fasta)
}
write.seqs(positive, 'pos')
write.seqs(negative, 'neg')
```
